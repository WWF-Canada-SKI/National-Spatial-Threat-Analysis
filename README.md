# National-Spatial-Threat-Analysis

This repository contains the analyses linked to the manuscript entitled 'Under pressure: The relationship between vertebrate populations and high-intensity cumulative threats in habitats across Canada'

##1. Threats_extraction.R
* code used to gather and preprocess input rasters
* includes steps to crop, resample, reproject and merge datasets into a consistent format
* output is a series of aligned, same-resolution and projection (Equal Area Conic) rasters

###Notes on use:
* make sure all required packages are installed
* change workspace directory to folder containing input data before running
* followed by the CombineThreats_quantiles.R script

##2. CombineThreats_quantiles.R
* code generates hexbin grid and calculates the average threat values and percentile of each threat within the hexbins
* determines the average quantile for all threats, and the number of threats exceeding the 90th percentile for each hexbin
* terrestrial threats are masked from marine areas, and vice versa
* contains code at the end to visualize data as maps (optional)
* outputs include CSV of all threat values per hexbin, shapefile with quantile and maximum number of threats over the 90th percentile in each hexbin

###Notes on use:
* make sure all required packages are installed
* change workspace directory to folder containing input data from previous code (processed rasters) before running
* followed by the Get_threats_per_pop.R script with threats shapefile from this code as the next input

##3. Get_threats_per_pop.R
* code used to extract the number of high intensity threats, cumulative threat and human population value for the grid cell where each population was monitored (by spatially overlapping the population coordinates with the threat grid)

###Notes on use:
* make sure all required packages are installed
* either followed by the Threats_models.R script (to run the models), or the Threat_network_merging_code.R (to prepare for the construction of the threat networks)

##4. Threats_models.R
* code to run mixed effects models to gauge the magnitude and direction of the effect size of explanatory variables on the response variable. The response variable is the average logged rate of population change (average lambda). Species and location are included as random effects. The predictors we considered are described in the manuscript.

###Notes on use:
* make sure all required packages are installed

##5. Threat_network_merging_code.R
* code to merge the time-series dataset with the data on presence/absence of individual threats in the grid cell containing the location where the population was monitored
* this step is needed to construct the threat network

###Notes on use:
* make sure all required packages are installed
* followed by the Canada threat networks_prep.R script with the output from this code as the next input

##6. Canada threat networks_prep.R
* code combines LPI population data and threat counts
* it then calculates the values for nodes and edges for a number of different threatened datasets:
  * all threatened populations
  * for each taxonomic group (fish, herptiles, mammals, birds)
  * for each system (marine and terrestrial/freshwater)
  * for each combination of taxonomic group and system (marine fish, marine herptiles, marine mammals, marine birds, freshwater fish, terr/fw herptiles, terr/fw mammals, terr/fw birds)
* outputs are CSV files of node and edge counts for:
  * all threatened populations
  * by taxonomic group
  * for each system
  * by system and taxonomic group

###Notes on use:
* make sure all required packages are installed
* change workspace directory to folder containing input data before running
* input data are: LPI populations file, and output from Threat_network_merging_code.R script
* followed by the Canada threat networks_scaled.R script with the objects generated by this code as the next input

##7.Canada threat networks_scaled.R
* takes node and edge values generated by Canada threat networks_prep.R script and scales them to a proportion of each subset
* it further scales values for better visualisation by 0.8 for all marine network counts, and by 0.4 for all terrestrial/freshwater network counts
* outputs are:
  * PDF files of networks for each data set, with blue nodes for marine subsets and yellow for terr/fw subsets
  * CSV files with the number of species and populations by taxonomic group for the marine and terrestrial/freshwater datasets separately

###Notes on use:
* make sure all required packages are installed
* change workspace directory to new folder before running
* rerun each network until the resulting graphic is legible
